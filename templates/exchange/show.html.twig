{% extends 'base.html.twig' %}

{% block title %}Détail de l'échange{% endblock %}

{% block body %}
    <div class="container mx-auto px-4 py-8">
        <h1 class="text-3xl font-bold mb-6">Détail de l'échange</h1>

        {% for label, messages in app.flashes %}
            {% for message in messages %}
                <div class="mb-4 p-4 rounded-lg {% if label == 'success' %}bg-green-100 text-green-800{% elseif label == 'error' %}bg-red-100 text-red-800{% else %}bg-blue-100 text-blue-800{% endif %}">
                    {{ message }}
                </div>
            {% endfor %}
        {% endfor %}

        <div class="bg-white shadow-md rounded-lg p-6 border border-gray-200 mb-6">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-semibold">Informations sur l'échange</h2>
                <span class="px-3 py-1 rounded-full text-sm font-medium
                    {% if exchange.status == 'pending' %}bg-yellow-100 text-yellow-800
                    {% elseif exchange.status == 'accepted' %}bg-blue-100 text-blue-800
                    {% elseif exchange.status == 'rejected' %}bg-red-100 text-red-800
                    {% elseif exchange.status == 'completed' %}bg-green-100 text-green-800
                    {% endif %}">
                    {{ exchange.status|capitalize }}
                </span>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div>
                    <h3 class="text-lg font-medium mb-3">Compétence offerte</h3>
                    <div class="bg-gray-50 p-4 rounded-md">
                        <div class="flex items-center mb-2">
                            <span class="font-medium mr-2">Nom:</span>
                            <span class="bg-blue-100 text-blue-800 px-2 py-1 rounded">{{ exchange.offeredSkill.name }}</span>
                        </div>
                        <div class="mb-2">
                            <span class="font-medium mr-2">Description:</span>
                            <span>{{ exchange.offeredSkill.description }}</span>
                        </div>
                        <div>
                            <span class="font-medium mr-2">Offert par:</span>
                            <span class="text-blue-600">{{ exchange.offerer.fullName }}</span>
                        </div>
                    </div>
                </div>

                <div>
                    <h3 class="text-lg font-medium mb-3">Compétence demandée</h3>
                    <div class="bg-gray-50 p-4 rounded-md">
                        <div class="flex items-center mb-2">
                            <span class="font-medium mr-2">Nom:</span>
                            <span class="bg-green-100 text-green-800 px-2 py-1 rounded">{{ exchange.requestedSkill.name }}</span>
                        </div>
                        <div class="mb-2">
                            <span class="font-medium mr-2">Description:</span>
                            <span>{{ exchange.requestedSkill.description }}</span>
                        </div>
                        <div>
                            <span class="font-medium mr-2">Demandé par:</span>
                            <span class="text-blue-600">{{ exchange.receiver.fullName }}</span>
                        </div>
                    </div>
                </div>
            </div>

            <div class="mt-4">
                <div class="font-medium">Date de création:</div>
                <div class="text-gray-600">{{ exchange.createdAt ? exchange.createdAt|date('d/m/Y à H:i') : '' }}</div>
            </div>
        </div>

        {% if exchange.reviews|length > 0 %}
        <div class="bg-white shadow-md rounded-lg p-6 border border-gray-200 mb-6">
            <h2 class="text-xl font-semibold mb-4">Avis sur cet échange</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                {% for review in exchange.reviews %}
                    <div class="bg-gray-50 p-4 rounded-md">
                        <div class="flex justify-between items-center mb-2">
                            <div class="font-medium">Avis de {{ review.reviewer.fullName }}</div>
                            <div class="flex">
                                {% for i in 1..5 %}
                                    {% if i <= review.rating %}
                                        <svg class="w-5 h-5 text-yellow-400" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg">
                                            <path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z"></path>
                                        </svg>
                                    {% else %}
                                        <svg class="w-5 h-5 text-gray-300" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg">
                                            <path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z"></path>
                                        </svg>
                                    {% endif %}
                                {% endfor %}
                            </div>
                        </div>
                        <p class="text-gray-700 mb-2">{{ review.comment|nl2br }}</p>
                        <div class="text-sm text-gray-500">{{ review.createdAt|date('d/m/Y') }}</div>
                        {% if app.user == review.reviewer %}
                            <div class="mt-2">
                                <a href="{{ path('app_review_edit', {'id': review.id}) }}" class="text-blue-600 hover:underline text-sm">Modifier mon avis</a>
                            </div>
                        {% endif %}
                    </div>
                {% endfor %}
            </div>
        </div>
        {% endif %}

        <div class="flex flex-wrap gap-2 mb-6">
            <a href="{{ path('app_exchange_index') }}" class="px-4 py-2 bg-gray-500 text-white rounded hover:bg-gray-600">Retour à la liste</a>
            
            {% if is_granted('EDIT', exchange) %}
                <a href="{{ path('app_exchange_edit', {'id': exchange.id}) }}" class="px-4 py-2 bg-blue-500 text-white rounded hover:bg-blue-600">Modifier</a>
            {% endif %}

            {% if exchange.status == 'pending' %}
                {% if app.user == exchange.receiver or is_granted('ROLE_ADMIN') %}
                    <form method="post" action="{{ path('app_exchange_accept', {'id': exchange.id}) }}" class="inline-block">
                        <input type="hidden" name="_token" value="{{ csrf_token('accept' ~ exchange.id) }}">
                        <button class="px-4 py-2 bg-green-500 text-white rounded hover:bg-green-600">Accepter</button>
                    </form>
                    <form method="post" action="{{ path('app_exchange_reject', {'id': exchange.id}) }}" class="inline-block">
                        <input type="hidden" name="_token" value="{{ csrf_token('reject' ~ exchange.id) }}">
                        <button class="px-4 py-2 bg-red-500 text-white rounded hover:bg-red-600">Rejeter</button>
                    </form>
                {% endif %}
            {% endif %}

            {% if exchange.status == 'accepted' %}
                {% if app.user == exchange.offerer or app.user == exchange.receiver or is_granted('ROLE_ADMIN') %}
                    <form method="post" action="{{ path('app_exchange_complete', {'id': exchange.id}) }}" class="inline-block">
                        <input type="hidden" name="_token" value="{{ csrf_token('complete' ~ exchange.id) }}">
                        <button class="px-4 py-2 bg-green-500 text-white rounded hover:bg-green-600">Marquer comme terminé</button>
                    </form>
                {% endif %}
            {% endif %}

            {% if exchange.status == 'completed' %}
                {% if (app.user == exchange.offerer or app.user == exchange.receiver) and not exchange.reviews|filter(review => review.reviewer == app.user)|length %}
                    <a href="{{ path('app_review_new', {'id': exchange.id}) }}" class="px-4 py-2 bg-yellow-500 text-white rounded hover:bg-yellow-600">Laisser un avis</a>
                {% endif %}
            {% endif %}

            {% if is_granted('DELETE', exchange) %}
                {{ include('exchange/_delete_form.html.twig') }}
            {% endif %}
        </div>
    </div>
{% endblock %}
